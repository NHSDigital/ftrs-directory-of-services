{"name": "Happy path migration for a GP Practice", "status": "broken", "statusDetails": {"message": "sqlalchemy.exc.IntegrityError: (psycopg2.errors.ForeignKeyViolation) insert or update on table \"services\" violates foreign key constraint \"fk_8a44833f10ee4cee\"\nDETAIL:  Key (parentid)=(150013) is not present in table \"services\".\n\n[SQL: INSERT INTO pathwaysdos.services (id, uid, name, odscode, isnational, openallhours, publicreferralinstructions, telephonetriagereferralinstructions, restricttoreferrals, address, town, postcode, easting, northing, publicphone, nonpublicphone, fax, email, web, createdby, createdtime, modifiedby, modifiedtime, lasttemplatename, lasttemplateid, typeid, parentid, subregionid, statusid, organisationid, returnifopenminutes, publicname, latitude, longitude, professionalreferralinfo, lastverified, nextverificationdue) VALUES (%(id)s, %(uid)s, %(name)s, %(odscode)s, %(isnational)s, %(openallhours)s, %(publicreferralinstructions)s, %(telephonetriagereferralinstructions)s, %(restricttoreferrals)s, %(address)s, %(town)s, %(postcode)s, %(easting)s, %(northing)s, %(publicphone)s, %(nonpublicphone)s, %(fax)s, %(email)s, %(web)s, %(createdby)s, %(createdtime)s, %(modifiedby)s, %(modifiedtime)s, %(lasttemplatename)s, %(lasttemplateid)s, %(typeid)s, %(parentid)s, %(subregionid)s, %(statusid)s, %(organisationid)s, %(returnifopenminutes)s, %(publicname)s, %(latitude)s, %(longitude)s, %(professionalreferralinfo)s, %(lastverified)s, %(nextverificationdue)s)]\n[parameters: {'id': 10005752, 'uid': '138179', 'name': 'Abbey Medical Practice, Evesham, Worcestershire', 'odscode': 'M81094', 'isnational': None, 'openallhours': False, 'publicreferralinstructions': 'STUB Public Referral Instruction Text Field 5752', 'telephonetriagereferralinstructions': 'STUB Telephone Triage Referral Instructions Text Field 5752', 'restricttoreferrals': True, 'address': 'Evesham Medical Centre$Abbey Lane$Evesham', 'town': 'EVESHAM', 'postcode': 'WR11 4BS', 'easting': 403453, 'northing': 243634, 'publicphone': '01386 761111', 'nonpublicphone': '99999 000000', 'fax': '77777 000000', 'email': None, 'web': 'www.abbeymedical.com', 'createdby': 'HUMAN', 'createdtime': datetime.datetime(2011, 6, 29, 8, 0, 51), 'modifiedby': 'HUMAN', 'modifiedtime': datetime.datetime(2024, 11, 29, 10, 55, 23), 'lasttemplatename': 'Midlands template R46 Append PC', 'lasttemplateid': 244764, 'typeid': 100, 'parentid': 150013, 'subregionid': 150013, 'statusid': 1, 'organisationid': None, 'returnifopenminutes': None, 'publicname': 'O#&39;Reilly Medical Practice', 'latitude': Decimal('52.0910543'), 'longitude': Decimal('-1.951003'), 'professionalreferralinfo': 'Non-public numbers are for healthcare professionals ONLY; they are not for routine contact and must not be shared with patients\\n* GP practice opening hours are 08:00-18:30, hours shown on DoS may vary for administration purposes.\"', 'lastverified': None, 'nextverificationdue': None}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "trace": "self = <sqlalchemy.engine.base.Connection object at 0x12930c110>, dialect = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x11a1b1670>\ncontext = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x1293d8230>, statement = <sqlalchemy.dialects.postgresql.base.PGCompiler object at 0x1297d3d10>\nparameters = [{'address': 'Evesham Medical Centre$Abbey Lane$Evesham', 'createdby': 'HUMAN', 'createdtime': datetime.datetime(2011, 6, 29, 8, 0, 51), 'easting': 403453, ...}]\n\n    def _exec_single_context(\n        self,\n        dialect: Dialect,\n        context: ExecutionContext,\n        statement: Union[str, Compiled],\n        parameters: Optional[_AnyMultiExecuteParams],\n    ) -> CursorResult[Any]:\n        \"\"\"continue the _execute_context() method for a single DBAPI\n        cursor.execute() or cursor.executemany() call.\n    \n        \"\"\"\n        if dialect.bind_typing is BindTyping.SETINPUTSIZES:\n            generic_setinputsizes = context._prepare_set_input_sizes()\n    \n            if generic_setinputsizes:\n                try:\n                    dialect.do_set_input_sizes(\n                        context.cursor, generic_setinputsizes, context\n                    )\n                except BaseException as e:\n                    self._handle_dbapi_exception(\n                        e, str(statement), parameters, None, context\n                    )\n    \n        cursor, str_statement, parameters = (\n            context.cursor,\n            context.statement,\n            context.parameters,\n        )\n    \n        effective_parameters: Optional[_AnyExecuteParams]\n    \n        if not context.executemany:\n            effective_parameters = parameters[0]\n        else:\n            effective_parameters = parameters\n    \n        if self._has_events or self.engine._has_events:\n            for fn in self.dispatch.before_cursor_execute:\n                str_statement, effective_parameters = fn(\n                    self,\n                    cursor,\n                    str_statement,\n                    effective_parameters,\n                    context,\n                    context.executemany,\n                )\n    \n        if self._echo:\n            self._log_info(str_statement)\n    \n            stats = context._get_cache_stats()\n    \n            if not self.engine.hide_parameters:\n                self._log_info(\n                    \"[%s] %r\",\n                    stats,\n                    sql_util._repr_params(\n                        effective_parameters,\n                        batches=10,\n                        ismulti=context.executemany,\n                    ),\n                )\n            else:\n                self._log_info(\n                    \"[%s] [SQL parameters hidden due to hide_parameters=True]\",\n                    stats,\n                )\n    \n        evt_handled: bool = False\n        try:\n            if context.execute_style is ExecuteStyle.EXECUTEMANY:\n                effective_parameters = cast(\n                    \"_CoreMultiExecuteParams\", effective_parameters\n                )\n                if self.dialect._has_events:\n                    for fn in self.dialect.dispatch.do_executemany:\n                        if fn(\n                            cursor,\n                            str_statement,\n                            effective_parameters,\n                            context,\n                        ):\n                            evt_handled = True\n                            break\n                if not evt_handled:\n                    self.dialect.do_executemany(\n                        cursor,\n                        str_statement,\n                        effective_parameters,\n                        context,\n                    )\n            elif not effective_parameters and context.no_parameters:\n                if self.dialect._has_events:\n                    for fn in self.dialect.dispatch.do_execute_no_params:\n                        if fn(cursor, str_statement, context):\n                            evt_handled = True\n                            break\n                if not evt_handled:\n                    self.dialect.do_execute_no_params(\n                        cursor, str_statement, context\n                    )\n            else:\n                effective_parameters = cast(\n                    \"_CoreSingleExecuteParams\", effective_parameters\n                )\n                if self.dialect._has_events:\n                    for fn in self.dialect.dispatch.do_execute:\n                        if fn(\n                            cursor,\n                            str_statement,\n                            effective_parameters,\n                            context,\n                        ):\n                            evt_handled = True\n                            break\n                if not evt_handled:\n>                   self.dialect.do_execute(\n                        cursor, str_statement, effective_parameters, context\n                    )\n\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x11a1b1670>, cursor = <cursor object at 0x1298f7100; closed: -1>\nstatement = 'INSERT INTO pathwaysdos.services (id, uid, name, odscode, isnational, openallhours, publicreferralinstructions, telep... %(publicname)s, %(latitude)s, %(longitude)s, %(professionalreferralinfo)s, %(lastverified)s, %(nextverificationdue)s)'\nparameters = {'address': 'Evesham Medical Centre$Abbey Lane$Evesham', 'createdby': 'HUMAN', 'createdtime': datetime.datetime(2011, 6, 29, 8, 0, 51), 'easting': 403453, ...}\ncontext = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x1293d8230>\n\n    def do_execute(self, cursor, statement, parameters, context=None):\n>       cursor.execute(statement, parameters)\nE       psycopg2.errors.ForeignKeyViolation: insert or update on table \"services\" violates foreign key constraint \"fk_8a44833f10ee4cee\"\nE       DETAIL:  Key (parentid)=(150013) is not present in table \"services\".\n\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: ForeignKeyViolation\n\nThe above exception was the direct cause of the following exception:\n\nfixturefunc = <function dos_data_insert_step at 0x1197f11c0>, request = <FixtureRequest for <Function test_happy_path_migration_for_a_gp_practice>>\nkwargs = {'datatable': [['key', 'value'], ['id', '10005752'], ['uid', '138179'], ['name', 'Abbey Medical Practice, Evesham, Wor...qlmodel.orm.session.Session object at 0x116f015e0>, 'migration_state': None, 'mock_logger': None, 'result': None, ...}}\n\n    def call_fixture_func(\n        fixturefunc: _FixtureFunc[FixtureValue], request: FixtureRequest, kwargs\n    ) -> FixtureValue:\n        if is_generator(fixturefunc):\n            fixturefunc = cast(\n                Callable[..., Generator[FixtureValue, None, None]], fixturefunc\n            )\n            generator = fixturefunc(**kwargs)\n            try:\n                fixture_result = next(generator)\n            except StopIteration:\n                raise ValueError(f\"{request.fixturename} did not yield a value\") from None\n            finalizer = functools.partial(_teardown_yield_fixture, fixturefunc, generator)\n            request.addfinalizer(finalizer)\n        else:\n            fixturefunc = cast(Callable[..., FixtureValue], fixturefunc)\n>           fixture_result = fixturefunc(**kwargs)\n\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/_pytest/fixtures.py:898: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \ntests/step_definitions/data_migration_steps/dos_data_manipulation_steps.py:241: in dos_data_insert_step\n    dos_db.commit()\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2032: in commit\n    trans.commit(_to_root=True)\n<string>:2: in commit\n    ???\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go\n    ret_value = fn(self, *arg, **kw)\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit\n    self._prepare_impl()\n<string>:2: in _prepare_impl\n    ???\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:137: in _go\n    ret_value = fn(self, *arg, **kw)\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl\n    self.session.flush()\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4345: in flush\n    self._flush(objects)\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4480: in _flush\n    with util.safe_reraise():\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:224: in __exit__\n    raise exc_value.with_traceback(exc_tb)\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4441: in _flush\n    flush_context.execute()\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute\n    rec.execute(self)\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute\n    util.preloaded.orm_persistence.save_obj(\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj\n    _emit_insert_statements(\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1048: in _emit_insert_statements\n    result = connection.execute(\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1419: in execute\n    return meth(\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection\n    return connection._execute_clauseelement(\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement\n    ret = self._execute_context(\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context\n    return self._exec_single_context(\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context\n    self._handle_dbapi_exception(\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context\n    self.dialect.do_execute(\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <sqlalchemy.dialects.postgresql.psycopg2.PGDialect_psycopg2 object at 0x11a1b1670>, cursor = <cursor object at 0x1298f7100; closed: -1>\nstatement = 'INSERT INTO pathwaysdos.services (id, uid, name, odscode, isnational, openallhours, publicreferralinstructions, telep... %(publicname)s, %(latitude)s, %(longitude)s, %(professionalreferralinfo)s, %(lastverified)s, %(nextverificationdue)s)'\nparameters = {'address': 'Evesham Medical Centre$Abbey Lane$Evesham', 'createdby': 'HUMAN', 'createdtime': datetime.datetime(2011, 6, 29, 8, 0, 51), 'easting': 403453, ...}\ncontext = <sqlalchemy.dialects.postgresql.psycopg2.PGExecutionContext_psycopg2 object at 0x1293d8230>\n\n    def do_execute(self, cursor, statement, parameters, context=None):\n>       cursor.execute(statement, parameters)\nE       sqlalchemy.exc.IntegrityError: (psycopg2.errors.ForeignKeyViolation) insert or update on table \"services\" violates foreign key constraint \"fk_8a44833f10ee4cee\"\nE       DETAIL:  Key (parentid)=(150013) is not present in table \"services\".\nE       \nE       [SQL: INSERT INTO pathwaysdos.services (id, uid, name, odscode, isnational, openallhours, publicreferralinstructions, telephonetriagereferralinstructions, restricttoreferrals, address, town, postcode, easting, northing, publicphone, nonpublicphone, fax, email, web, createdby, createdtime, modifiedby, modifiedtime, lasttemplatename, lasttemplateid, typeid, parentid, subregionid, statusid, organisationid, returnifopenminutes, publicname, latitude, longitude, professionalreferralinfo, lastverified, nextverificationdue) VALUES (%(id)s, %(uid)s, %(name)s, %(odscode)s, %(isnational)s, %(openallhours)s, %(publicreferralinstructions)s, %(telephonetriagereferralinstructions)s, %(restricttoreferrals)s, %(address)s, %(town)s, %(postcode)s, %(easting)s, %(northing)s, %(publicphone)s, %(nonpublicphone)s, %(fax)s, %(email)s, %(web)s, %(createdby)s, %(createdtime)s, %(modifiedby)s, %(modifiedtime)s, %(lasttemplatename)s, %(lasttemplateid)s, %(typeid)s, %(parentid)s, %(subregionid)s, %(statusid)s, %(organisationid)s, %(returnifopenminutes)s, %(publicname)s, %(latitude)s, %(longitude)s, %(professionalreferralinfo)s, %(lastverified)s, %(nextverificationdue)s)]\nE       [parameters: {'id': 10005752, 'uid': '138179', 'name': 'Abbey Medical Practice, Evesham, Worcestershire', 'odscode': 'M81094', 'isnational': None, 'openallhours': False, 'publicreferralinstructions': 'STUB Public Referral Instruction Text Field 5752', 'telephonetriagereferralinstructions': 'STUB Telephone Triage Referral Instructions Text Field 5752', 'restricttoreferrals': True, 'address': 'Evesham Medical Centre$Abbey Lane$Evesham', 'town': 'EVESHAM', 'postcode': 'WR11 4BS', 'easting': 403453, 'northing': 243634, 'publicphone': '01386 761111', 'nonpublicphone': '99999 000000', 'fax': '77777 000000', 'email': None, 'web': 'www.abbeymedical.com', 'createdby': 'HUMAN', 'createdtime': datetime.datetime(2011, 6, 29, 8, 0, 51), 'modifiedby': 'HUMAN', 'modifiedtime': datetime.datetime(2024, 11, 29, 10, 55, 23), 'lasttemplatename': 'Midlands template R46 Append PC', 'lasttemplateid': 244764, 'typeid': 100, 'parentid': 150013, 'subregionid': 150013, 'statusid': 1, 'organisationid': None, 'returnifopenminutes': None, 'publicname': 'O#&39;Reilly Medical Practice', 'latitude': Decimal('52.0910543'), 'longitude': Decimal('-1.951003'), 'professionalreferralinfo': 'Non-public numbers are for healthcare professionals ONLY; they are not for routine contact and must not be shared with patients\\n* GP practice opening hours are 08:00-18:30, hours shown on DoS may vary for administration purposes.\"', 'lastverified': None, 'nextverificationdue': None}]\nE       (Background on this error at: https://sqlalche.me/e/20/gkpj)\n\n../../../../../Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/default.py:951: IntegrityError"}, "steps": [{"name": "Given the test environment is configured", "status": "passed", "parameters": [{"name": "migration_helper", "value": "<utilities.data_migration.migration_helper.MigrationHelper object at 0x12930ec90>"}, {"name": "dynamodb", "value": "{'client': <botocore.client.DynamoDB object at 0x11a236d80>, 'resource': dynamodb.ServiceResource(), 'endpoint_url': 'http://localhost:57726'}"}], "start": 1769167909626, "stop": 1769167932490}, {"name": "And the DoS database has test data", "status": "passed", "parameters": [{"name": "dos_db", "value": "<sqlmodel.orm.session.Session object at 0x116f015e0>"}], "start": 1769167932492, "stop": 1769167934484}, {"name": "And DynamoDB tables are ready", "status": "passed", "parameters": [{"name": "dynamodb", "value": "{'client': <botocore.client.DynamoDB object at 0x11a236d80>, 'resource': dynamodb.ServiceResource(), 'endpoint_url': 'http://localhost:57726'}"}], "start": 1769167934486, "stop": 1769167934523}, {"name": "Given a \"Service\" exists in DoS with attributes", "status": "broken", "statusDetails": {"message": "sqlalchemy.exc.IntegrityError: (psycopg2.errors.ForeignKeyViolation) insert or update on table \"services\" violates foreign key constraint \"fk_8a44833f10ee4cee\"\nDETAIL:  Key (parentid)=(150013) is not present in table \"services\".\n\n[SQL: INSERT INTO pathwaysdos.services (id, uid, name, odscode, isnational, openallhours, publicreferralinstructions, telephonetriagereferralinstructions, restricttoreferrals, address, town, postcode, easting, northing, publicphone, nonpublicphone, fax, email, web, createdby, createdtime, modifiedby, modifiedtime, lasttemplatename, lasttemplateid, typeid, parentid, subregionid, statusid, organisationid, returnifopenminutes, publicname, latitude, longitude, professionalreferralinfo, lastverified, nextverificationdue) VALUES (%(id)s, %(uid)s, %(name)s, %(odscode)s, %(isnational)s, %(openallhours)s, %(publicreferralinstructions)s, %(telephonetriagereferralinstructions)s, %(restricttoreferrals)s, %(address)s, %(town)s, %(postcode)s, %(easting)s, %(northing)s, %(publicphone)s, %(nonpublicphone)s, %(fax)s, %(email)s, %(web)s, %(createdby)s, %(createdtime)s, %(modifiedby)s, %(modifiedtime)s, %(lasttemplatename)s, %(lasttemplateid)s, %(typeid)s, %(parentid)s, %(subregionid)s, %(statusid)s, %(organisationid)s, %(returnifopenminutes)s, %(publicname)s, %(latitude)s, %(longitude)s, %(professionalreferralinfo)s, %(lastverified)s, %(nextverificationdue)s)]\n[parameters: {'id': 10005752, 'uid': '138179', 'name': 'Abbey Medical Practice, Evesham, Worcestershire', 'odscode': 'M81094', 'isnational': None, 'openallhours': False, 'publicreferralinstructions': 'STUB Public Referral Instruction Text Field 5752', 'telephonetriagereferralinstructions': 'STUB Telephone Triage Referral Instructions Text Field 5752', 'restricttoreferrals': True, 'address': 'Evesham Medical Centre$Abbey Lane$Evesham', 'town': 'EVESHAM', 'postcode': 'WR11 4BS', 'easting': 403453, 'northing': 243634, 'publicphone': '01386 761111', 'nonpublicphone': '99999 000000', 'fax': '77777 000000', 'email': None, 'web': 'www.abbeymedical.com', 'createdby': 'HUMAN', 'createdtime': datetime.datetime(2011, 6, 29, 8, 0, 51), 'modifiedby': 'HUMAN', 'modifiedtime': datetime.datetime(2024, 11, 29, 10, 55, 23), 'lasttemplatename': 'Midlands template R46 Append PC', 'lasttemplateid': 244764, 'typeid': 100, 'parentid': 150013, 'subregionid': 150013, 'statusid': 1, 'organisationid': None, 'returnifopenminutes': None, 'publicname': 'O#&39;Reilly Medical Practice', 'latitude': Decimal('52.0910543'), 'longitude': Decimal('-1.951003'), 'professionalreferralinfo': 'Non-public numbers are for healthcare professionals ONLY; they are not for routine contact and must not be shared with patients\\n* GP practice opening hours are 08:00-18:30, hours shown on DoS may vary for administration purposes.\"', 'lastverified': None, 'nextverificationdue': None}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)\n", "trace": "  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/pytest_bdd/scenario.py\", line 240, in _execute_step_function\n    return_value = call_fixture_func(fixturefunc=context.step_func, request=request, kwargs=kwargs)\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/_pytest/fixtures.py\", line 898, in call_fixture_func\n    fixture_result = fixturefunc(**kwargs)\n                     ^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/sylwia.luczak-jagiela/work/NHSDigital/ftrs-directory-of-services/tests/service_automation/tests/step_definitions/data_migration_steps/dos_data_manipulation_steps.py\", line 241, in dos_data_insert_step\n    dos_db.commit()\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 2032, in commit\n    trans.commit(_to_root=True)\n  File \"<string>\", line 2, in commit\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n                ^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 1313, in commit\n    self._prepare_impl()\n  File \"<string>\", line 2, in _prepare_impl\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n                ^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 1288, in _prepare_impl\n    self.session.flush()\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 4345, in flush\n    self._flush(objects)\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 4480, in _flush\n    with util.safe_reraise():\n         ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 4441, in _flush\n    flush_context.execute()\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py\", line 466, in execute\n    rec.execute(self)\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py\", line 642, in execute\n    util.preloaded.orm_persistence.save_obj(\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py\", line 93, in save_obj\n    _emit_insert_statements(\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py\", line 1048, in _emit_insert_statements\n    result = connection.execute(\n             ^^^^^^^^^^^^^^^^^^^\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1419, in execute\n    return meth(\n           ^^^^^\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/sql/elements.py\", line 526, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n          ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 2355, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n  File \"/Users/sylwia.luczak-jagiela/Library/Caches/pypoetry/virtualenvs/service-test-automation-K7h1z1Mb-py3.12/lib/python3.12/site-packages/sqlalchemy/engine/default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n"}, "attachments": [{"name": "Data table", "source": "a4d95ed2-7dd9-42d8-8ad8-bf1761da16d4-attachment.csv", "type": "text/csv"}], "parameters": [{"name": "entity_name", "value": "'Service'"}, {"name": "migration_context", "value": "{'service_id': None, 'result': None, 'service_data': {}, 'service_name': '', 'sqs_event': {}, 'sqs_service_ids': [], 'sqs_service_id': None, 'mock_logger': None, 'migration_state': None, 'db_session': <sqlmodel.orm.session.Session object at 0x116f015e0>}"}, {"name": "dos_db", "value": "<sqlmodel.orm.session.Session object at 0x116f015e0>"}], "start": 1769167934524, "stop": 1769167934709}, {"name": "When the data migration process is run for table 'services', ID '10005752' and method 'insert'", "status": "skipped", "start": 1769167938070, "stop": 1769167938070}, {"name": "Then the SQS event metrics should be 1 total, 1 supported, 0 unsupported, 1 transformed, 1 inserted, 0 updated, 0 skipped and 0 errors", "status": "skipped", "start": 1769167938070, "stop": 1769167938070}, {"name": "Then there is 1 organisation, 1 location and 1 healthcare services created", "status": "skipped", "start": 1769167938070, "stop": 1769167938070}, {"name": "Then the state table contains a record for key 'services#10005752' with version 1", "status": "skipped", "start": 1769167938070, "stop": 1769167938070}, {"name": "Then the state table contains 2 validation issue(s) for key 'services#10005752'", "status": "skipped", "start": 1769167938070, "stop": 1769167938070}, {"name": "Then the state table contains the following validation issues for key 'services#10005752':", "status": "skipped", "start": 1769167938070, "stop": 1769167938070}, {"name": "Then the 'organisation' for service ID '10005752' has content:", "status": "skipped", "start": 1769167938070, "stop": 1769167938070}, {"name": "Then the 'healthcare-service' for service ID '10005752' has content:", "status": "skipped", "start": 1769167938070, "stop": 1769167938070}, {"name": "Then the 'location' for service ID '10005752' has content:", "status": "skipped", "start": 1769167938070, "stop": 1769167938070}], "attachments": [{"name": "log", "source": "b56c325b-6281-499f-b3a8-aa554d14ab19-attachment.txt", "type": "text/plain"}, {"name": "stderr", "source": "2396d748-e8c0-4bae-9e11-00011c38e81b-attachment.txt", "type": "text/plain"}], "start": 1769167909622, "stop": 1769167934709, "uuid": "01122033-5789-c54f-a74c-1d03ac24d1a4", "historyId": "fe363e221bfd065c26fb5fea5fd06439.d41d8cd98f00b204e9800998ecf8427e", "testCaseId": "fe363e221bfd065c26fb5fea5fd06439", "fullName": "data_migration_features/gp_practice_migration_happy_path.feature:Happy path migration for a GP Practice", "labels": [{"name": "host", "value": "C02FG0LCML85"}, {"name": "thread", "value": "67374-MainThread"}, {"name": "framework", "value": "pytest-bdd"}, {"name": "language", "value": "cpython3"}, {"name": "feature", "value": "Data Migration"}, {"name": "tag", "value": "data-migration"}, {"name": "tag", "value": "happy"}]}