name: 'Build open search indexes action'
description: 'Builds the required indexes in open search'

inputs:
  workspace:
    description: 'The name of the workspace'
    required: false
    default: ''
  environment:
    description: 'Environment to authenticate against (e.g., dev, test, prod)'
    required: true
  domain:
    description: 'The name of the collection to target (defaults to ftrs-dos-dev-osc)'
    required: true
    default: 'ftrs-dos-dev-osc'
  index:
    description: 'The OpenSearch index name to create'
    required: true
    default: 'organisation'
  aws_region:
    description: 'AWS region to use for AWS CLI and boto3 calls (optional)'
    required: true
    default: ''
  table:
    description: 'The DynamoDB table name to use'
    required: true
    default: 'ftrs-dos-dev-database-healthcare-service'
runs:
  using: 'composite'
  steps:
    - name: Create OpenSearch index
      id: create_index
      shell: bash
      env:
        INDEX: ${{ inputs.index }}
        OPEN_SEARCH_DOMAIN: ${{ inputs.domain }}
        WORKSPACE: ${{ inputs.workspace }}
        ENVIRONMENT: ${{ inputs.environment }}
        AWS_REGION: ${{ inputs.aws_region }}
        DYNAMODB_TABLE: ${{ inputs.table }}
      run: |
        set -euo pipefail

        echo "Using OPEN_SEARCH_DOMAIN=${OPEN_SEARCH_DOMAIN} INDEX=${INDEX} WORKSPACE=${WORKSPACE} AWS_REGION=${AWS_REGION:-<unset>} DYNAMODB_TABLE=${DYNAMODB_TABLE}"

        python3 -m pip install --upgrade pip setuptools wheel

        if [ -f "./scripts/workflow/requirements.txt" ]; then
          python3 -m pip install -r ./scripts/workflow/requirements.txt
        else
          python3 -m pip install boto3 requests
        fi

        python3 ./scripts/workflow/create_open_search_index.py

        python3 ./scripts/workflow/populate_open_search_index.py
