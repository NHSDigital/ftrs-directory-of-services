name: Build Release Candidate Pipeline

# Workflow description
# Intended to run when manually triggered to build a release candidate.
# The workspace is set to the release tag, and the environment defaults to test.
# This workflow will:
# - Promote the release candidate
# - Provision a temporary AWS workspace in the test environment
# - Run automated tests
# - Perform cleardown of infrastructure

# checkov:skip=CKV_GHA_7:Workflow dispatch inputs are required for manual triggering with environment selection
on:
  workflow_dispatch:
    inputs:
      prerelease_tag:
        description: "The prerelease tag to build the release artefacts from (if not provided, the latest will be used)"
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  metadata:
    name: "Get CI/CD metadata"
    uses: ./.github/workflows/metadata.yaml
    with:
      environment: "test"

  tag-release:
    name: "Generate the next release tag"
    needs:
      - metadata
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.create-rc.outputs.release_tag }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: "Check branch is up to date with main"
        run: |
          git fetch origin main --prune
          BEHIND_COUNT=$(git rev-list --count HEAD..origin/main)
          if [[ "$BEHIND_COUNT" -gt 0 ]]; then
            echo "Branch is behind origin/main. Please rerun the pipeline to use the latest commit."
            exit 1
          fi

      - name: "Run Semantic Release"
        id: semantic-release
        uses: cycjimmy/semantic-release-action@b12c8f6015dc215fe37bc154d4ad456dd3833c90 # v6.0.0
        with:
          dry_run: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Generate next RC tag"
        id: create-rc
        run: |
          # Get the last and new semantic-release versions
          LAST_VERSION="${{ steps.semantic-release.outputs.last_release_version }}"
          NEW_VERSION="${{ steps.semantic-release.outputs.new_release_version }}"

          # If no new version, fallback to last version
          if [[ -z "$NEW_VERSION" || "$NEW_VERSION" == "$LAST_VERSION" ]]; then
            echo "No new release detected, using last released version: $LAST_VERSION"
            VERSION_TO_USE="$LAST_VERSION"
          else
            VERSION_TO_USE="$NEW_VERSION"
          fi

          # Generate RC tag using your RC script
          RC_TAG=$(scripts/workflow/generate-rc-tag.sh "$VERSION_TO_USE")

          # Output for subsequent steps
          echo "release_tag=$RC_TAG" >> $GITHUB_OUTPUT

  promote-release-candidate:
    name: "Promote artefacts for release candidate ${{ needs.tag-release.outputs.release_tag }}"
    needs:
      - metadata
      - tag-release
    uses: ./.github/workflows/promote-artefacts.yaml
    with:
      repo_name: ${{ needs.metadata.outputs.reponame }}
      artefact_promotion_type: "release-candidate"
      type: app
      release_tag: ${{ needs.tag-release.outputs.release_tag }}
      prerelease_tag: ${{ github.event.inputs.prerelease_tag || '' }}
    secrets:
      ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  prepare-toggle-artifacts:
    name: "Prepare Toggle artifacts"
    needs:
      - metadata
      - tag-release
      - promote-release-candidate
    uses: ./.github/workflows/prepare-toggle-artifacts.yaml
    with:
      environment: ${{ needs.metadata.outputs.environment }}
      workspace: "rc"
      ref: ${{ needs.tag-release.outputs.release_tag }}

  check-stack-toggles:
    name: "Check stack toggles for ${{ needs.metadata.outputs.environment }}"
    needs:
      - metadata
      - tag-release
      - prepare-toggle-artifacts
    uses: ./.github/workflows/check-stack-toggles.yaml
    with:
      environment: ${{ needs.metadata.outputs.environment }}
      workspace: "rc"
      ref: ${{ needs.tag-release.outputs.release_tag }}

  deploy-toggle-infrastructure:
    name: "Deploy toggle infrastructure to the ${{ needs.metadata.outputs.environment }} environment"
    needs:
      - metadata
      - tag-release
      - check-stack-toggles
    uses: ./.github/workflows/deploy-application-infrastructure.yaml
    with:
      environment: ${{ needs.metadata.outputs.environment }}
      workspace: "rc"
      ref: ${{ needs.tag-release.outputs.release_tag }}
      workflow_timeout: 30
      stacks: "['app_config']"
      skip_manual_approval: "true"
    secrets:
      ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}
      MGMT_ACCOUNT_ID: ${{ secrets.MGMT_ACCOUNT_ID }}

  deploy-application-infrastructure:
    name: "Deploy application infrastructure for release candidate ${{ needs.tag-release.outputs.release_tag }} in the ${{ needs.metadata.outputs.environment }} environment"
    needs:
      - metadata
      - tag-release
      - deploy-toggle-infrastructure
    uses: ./.github/workflows/deploy-application-infrastructure.yaml
    with:
      stacks: "['database', 'crud_apis', 'data_migration', 'read_only_viewer', 'opensearch', 'etl_ods', 'dos_search', 'is_performance', 'ui']"
      environment: ${{ needs.metadata.outputs.environment }}
      workspace: "rc"
      release_tag: ${{ needs.tag-release.outputs.release_tag }}
      ref: ${{ needs.tag-release.outputs.release_tag }}
      workflow_timeout: 30
    secrets:
      ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}
      MGMT_ACCOUNT_ID: ${{ secrets.MGMT_ACCOUNT_ID }}

  restore-dynamodb-from-s3:
    name: "Restore S3 data to DynamoDB tables for release candidate in the ${{ needs.metadata.outputs.environment }} environment"
    if: ${{ needs.metadata.outputs.environment && needs.metadata.outputs.environment != 'prod' }}
    needs:
      - metadata
      - tag-release
      - deploy-application-infrastructure
    uses: ./.github/workflows/manage-dynamodb-data.yaml
    with:
      environment: ${{ needs.metadata.outputs.environment }}
      workspace: "rc"
      action: import
      type: app
      ref: ${{ needs.tag-release.outputs.release_tag }}
    secrets:
      ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}

  deploy-frontend-services:
    name: "Deploy ${{ matrix.name }} to ${{ needs.metadata.outputs.environment }}"
    concurrency:
      group: "${{ needs.metadata.outputs.environment }}-${{ needs.metadata.outputs.workspace }}-${{ matrix.name }}"
      cancel-in-progress: false
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "dos-ui"
            enabled: ${{ needs.check-stack-toggles.outputs.ui_enabled }}
          - name: "read-only-viewer"
            enabled: ${{ needs.check-stack-toggles.outputs.read_only_viewer_enabled }}
    needs:
      - metadata
      - check-stack-toggles
      - tag-release
      - deploy-application-infrastructure
    uses: ./.github/workflows/deploy-frontend-project.yaml
    with:
      name: ${{ matrix.name }}
      enabled: ${{ matrix.enabled }}
      build_type: "service"
      environment: ${{ needs.metadata.outputs.environment }}
      repo_name: ${{ needs.metadata.outputs.reponame }}
      workspace: "rc"
      type: "app"
      ref: ${{ needs.tag-release.outputs.release_tag }}
    secrets:
      ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}

  deploy-data-migration-service:
    name: "Deploy data migration service for release candidate ${{ needs.tag-release.outputs.release_tag }} in the ${{ needs.metadata.outputs.environment }} environment"
    concurrency:
      group: "${{ needs.metadata.outputs.environment }}-data-migration-${{ needs.tag-release.outputs.release_tag }}"
      cancel-in-progress: false
    needs:
      - metadata
      - tag-release
      - deploy-application-infrastructure
    uses: ./.github/workflows/deploy-data-migration-project.yaml
    with:
      name: "data-migration"
      build_type: "service"
      python_version: ${{ needs.metadata.outputs.python_version }}
      environment: ${{ needs.metadata.outputs.environment }}
      repo_name: ${{ needs.metadata.outputs.reponame }}
      workspace: "rc"
      type: "app"
      ref: ${{ needs.tag-release.outputs.release_tag }}
    secrets:
      ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}

  service-automation-tests:
    name: "Run ${{ matrix.tag }} service automation tests on ${{ needs.metadata.outputs.environment }} environment"
    strategy:
      fail-fast: false
      matrix:
        include:
          - tag: "ftrs-pipeline"
            type: "api"
          - tag: "data-migration"
            type: "data-migration"
    needs:
      - metadata
      - tag-release
      - deploy-data-migration-service
    uses: ./.github/workflows/service-automation-test.yaml
    with:
      environment: ${{ needs.metadata.outputs.environment }}
      workspace: "rc"
      ref: ${{ needs.tag-release.outputs.release_tag }}
      commit_hash: ${{ needs.metadata.outputs.commit_hash }}
      test_tag: ${{ matrix.tag }}
      test_type: ${{ matrix.type }}
      type: app
      deployment_type: "release-candidate"
    secrets:
      ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}
      MGMT_ACCOUNT_ID: ${{ secrets.MGMT_ACCOUNT_ID }}
      PROXYGEN_URL: ${{ secrets.PROXYGEN_URL }}

  trigger-cleardown-pipeline:
    name: "Trigger Cleardown Application Infrastructure Pipeline"
    needs:
      - metadata
      - tag-release
      - service-automation-tests
    runs-on: ubuntu-latest
    steps:
      - name: Trigger downstream cleardown pipeline
        uses: peter-evans/repository-dispatch@v4
        with:
          repository: ${{ github.repository }}
          event-type: release-build-cleardown
          client-payload: '{"environment": "${{ needs.metadata.outputs.environment }}", "workspace": "rc", "release_tag": "${{ needs.tag-release.outputs.release_tag }}"}'

  check-pipeline-status:
    name: "Check pipeline status"
    needs:
      - trigger-cleardown-pipeline
    if: always()
    uses: ./.github/workflows/pipeline-status-check.yaml

  slack-notifications:
    name: "Send Notification to Slack"
    needs:
      - metadata
      - promote-release-candidate
      - prepare-toggle-artifacts
      - check-stack-toggles
      - deploy-toggle-infrastructure
      - deploy-application-infrastructure
      - restore-dynamodb-from-s3
      - check-stack-toggles
      - deploy-frontend-services
      - deploy-data-migration-service
      - service-automation-tests
      - trigger-cleardown-pipeline
      - check-pipeline-status
    if: always()
    uses: ./.github/workflows/slack-notifications.yaml
    with:
      env: ${{ needs.metadata.outputs.environment }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
