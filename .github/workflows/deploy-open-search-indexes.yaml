name: Create index

permissions:
  id-token: write
  contents: read
on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to authenticate against (e.g., dev, test, prod)'
        required: true
        type: string
      workspace:
        description: "The name of the workspace to deploy the application into"
        required: true
        type: string
      aws_region:
        description: 'AWS region to use for AWS CLI calls'
        required: false
        type: string

jobs:
  build-index:
    name: Build index
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Configure AWS Credentials
        uses: ./.github/actions/configure-credentials
        with:
          aws_account_id: ${{ secrets.ACCOUNT_ID }}
          aws_region: ${{ inputs.aws_region }}
          type: app

      - name: Debug AWS credentials (non-sensitive)
        shell: bash
        run: |
          set -euo pipefail
          # Print whether the typical AWS env vars are set (do not print values)
          if [ -n "${AWS_ACCESS_KEY_ID:-}" ]; then echo "AWS_ACCESS_KEY_ID: set"; else echo "AWS_ACCESS_KEY_ID: unset"; fi
          if [ -n "${AWS_SECRET_ACCESS_KEY:-}" ]; then echo "AWS_SECRET_ACCESS_KEY: set"; else echo "AWS_SECRET_ACCESS_KEY: unset"; fi
          if [ -n "${AWS_SESSION_TOKEN:-}" ]; then echo "AWS_SESSION_TOKEN: set"; else echo "AWS_SESSION_TOKEN: unset"; fi
          if [ -n "${AWS_REGION:-}" ]; then echo "AWS_REGION: ${AWS_REGION}"; else echo "AWS_REGION: unset"; fi
          if [ -n "${AWS_DEFAULT_REGION:-}" ]; then echo "AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}"; else echo "AWS_DEFAULT_REGION: unset"; fi

          # Try a simple STS call to confirm credentials are usable; print the exit code on failure
          if command -v aws >/dev/null 2>&1; then
            echo "Running 'aws sts get-caller-identity' for verification"
            aws sts get-caller-identity ${AWS_REGION:+--region "${AWS_REGION}"} --query Account --output text || echo "aws sts failed with exit $?"
          else
            echo "aws CLI not found"
          fi

      - name:  Create OpenSearch Index
        id: create-index
        uses: ./.github/actions/build-open-search-indexes
        with:
          environment: ${{ inputs.environment }}
          workspace: ${{ inputs.workspace }}
          aws_region: ${{ inputs.aws_region }}
