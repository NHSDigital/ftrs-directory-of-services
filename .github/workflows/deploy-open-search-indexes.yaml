name: Deploy Open Search Indexes workflow

permissions:
  id-token: write
  contents: read
on:
  workflow_call:
    inputs:
      environment:
        description: "The name of the environment to deploy into"
        required: true
        type: string
      workspace:
        description: "The name of the workspace to deploy the application into"
        required: true
        type: string
      domain:
        description: "The name of the domain to deploy from. If not supplied, we will deploy from the domain that has invoked the workflow"
        required: false
        default: ${{ github.event.repository.name }}
        type: string
      tag:
        description: "The tag to build and deploy from"
        required: false
        default: ""
        type: string
      type:
        description: "The type of permissions (e.g., account, app)"
        required: true
        type: string
jobs:
  create-index:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: "Checkout code"
        uses: NHSDigital/uec-dos-management/.github/actions/checkout-repository@latest
        with:
          repository: ${{ inputs.domain }}
          tag: ${{ inputs.tag }}

      - name: Configure AWS Credentials
        uses: NHSDigital/uec-dos-management/.github/actions/configure-credentials@latest
        with:
          aws_account_id: ${{ secrets.ACCOUNT_ID }}
          aws_region: ${{ vars.AWS_REGION }}
          type: ${{ inputs.type }}

      - name: Create OpenSearch Index
        run: |
          COLLECTION_NAME="ftrs-dos-dev-osc"

          # Derive the OpenSearch Serverless collection endpoint (assumes aws CLI + AWS_REGION available)
          AWS_REGION="${AWS_REGION:-$(aws configure get region || true)}"
          COLLECTION_ID=$(aws opensearchserverless list-collections --region "$AWS_REGION" --query "collections[?name=='${COLLECTION_NAME}'] | [0].id" --output text 2>/dev/null || true)
          COLLECTION_INFO=$(aws opensearchserverless get-collection --id "$COLLECTION_ID" --region "$AWS_REGION" --output json 2>/dev/null || true)
          OPEN_SEARCH_DOMAIN=$(printf '%s' "$COLLECTION_INFO" | grep -oE 'https?://[A-Za-z0-9.-]+' | sed -E 's#https?://##' | head -n1 || true)
          echo "Derived OPEN_SEARCH_DOMAIN=${OPEN_SEARCH_DOMAIN} from collection ${COLLECTION_NAME}"

          export OPEN_SEARCH_DOMAIN

          # Normalize and export workspace (prefixed with '-')
          WORKSPACE_INPUT="${{ inputs.workspace }}"
          if [[ -n "$WORKSPACE_INPUT" ]]; then
            WORKSPACE="-${WORKSPACE_INPUT#-}"
          else
            WORKSPACE=""
          fi
          export WORKSPACE

          # Choose index name (kept minimal as before)
          INDEX="my-index"
          export INDEX

          echo "Calling build script to create index: ${INDEX}${WORKSPACE} on ${OPEN_SEARCH_DOMAIN}"

          # Ensure script is executable and delegate creation to it
          chmod +x ./scripts/workflow/build-open-search-index.sh || true
          /bin/bash ./scripts/workflow/build-open-search-index.sh
        shell: bash
