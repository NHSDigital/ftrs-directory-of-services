name: Deploy API to Proxygen

permissions:
  id-token: write
  contents: read

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: string
      workspace:
        description: 'Workspace identifier (e.g., FTRS-000)'
        required: true
        type: string
      api_name:
        description: 'API name'
        required: true
        type: string
      proxy_env:
        description: 'Proxy environment (e.g., internal-dev)'
        required: true
        type: string
      access_token:
        description: 'Access token for authentication'
        required: true
        type: string

jobs:
  deploy:
    name: Deploy to Proxygen
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Validate inputs
        run: |
          echo "Validating deployment inputs..."
          echo "Environment: ${{ inputs.environment }}"
          echo "Workspace: ${{ inputs.workspace }}"
          echo "API Name: ${{ inputs.api_name }}"

      - name: Deploy API Specification
        uses: ./.github/actions/deploy-to-proxygen
        with:
          api_name: ${{ inputs.api_name }}
          workspace: ${{ inputs.workspace }}
          environment: ${{ inputs.environment }}
          proxy_env: ${{ inputs.proxy_env }}
          access_token: ${{ inputs.access_token }}

      - name: Deployment Summary
        run: |
          echo "### Deployment Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Name | \`${{ inputs.api_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Workspace | \`${{ inputs.workspace }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "### Deployment Failed âŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment to Proxygen failed. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
