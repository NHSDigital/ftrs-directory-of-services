name: APIM Build & Deploy

permissions:
  id-token: write
  contents: read

on:
  push:
    branches:
      - main
      - task/DOSIS*

jobs:

  metadata:
    name: "Get CI/CD metadata"
    uses: ./.github/workflows/metadata.yaml
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      ENVIRONMENT: internal-dev
      API_NAME: dos-search
      FHIR_VERSION: FHIR_R4
      WORKSPACE: ${{ needs.metadata.outputs.workspace }} # branch name or PR ref

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Install proxygen CLI
        run: |
          pip install proxygen-cli
          echo "$HOME/.proxygen/bin" >> $GITHUB_PATH

      - name: Preprocess OAS file
        run: |
          # Prefix title with issue tag
          yq '.info.title = "[" + "${WORKSPACE}" + "] " + .info.title' \
            docs/specification/dos-search.yaml > docs/specification/dos-search.yaml

      - name: Validate OpenAPI spec
        run: |
          npx @redocly/cli lint docs/specification/dos-search.yaml

      - name: Deploy to APIM
        run: |
          proxygen instance deploy \
            $ENVIRONMENT \
            "${WORKSPACE}-${API_NAME}_${FHIR_VERSION}" \
            "docs/specification/dos-search.yaml"

      - name: Post-deployment check
        run: |
          proxygen instance list $ENVIRONMENT | grep "${WORKSPACE}-${API_NAME}_${FHIR_VERSION}"
