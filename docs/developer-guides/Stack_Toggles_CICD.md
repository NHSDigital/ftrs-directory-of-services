# Stack Toggle CI/CD Integration Guide

## Overview

Stack toggles are automatically generated during CI/CD deployments. This document explains how the integration works and how to verify it.

## Automatic Generation

### When Toggles are Generated

Stack toggle tfvars files are automatically generated:
- Before every Terraform plan
- Before every Terraform apply
- Before every Terraform destroy
- For the specific environment being deployed

### Integration Points

**Primary Integration**: `scripts/workflow/action-infra-stack.sh`

This script is called by the GitHub Actions infrastructure deployment workflow for every stack deployment.

**Location in Script**:
```bash
# After environment directory validation
# Before Terraform initialization

echo "Generating stack toggles for environment: $ENVIRONMENT"
python3 scripts/generate-stack-toggles.py --environment "$ENVIRONMENT"
```

**Workflow Setup**: `.github/workflows/deploy-infrastructure.yaml`

Python and dependencies are installed before deployment:
```yaml
- name: "Setup Python for stack toggles"
  uses: actions/setup-python@v5
  with:
    python-version: '3.x'

- name: "Install Python dependencies for stack toggles"
  run: |
    python -m pip install --upgrade pip
    pip install pyyaml
```

## Verification

### Check CI Logs

In GitHub Actions workflow runs, look for these log entries:

**Successful Generation**:
```
Generating stack toggles for environment: dev
Generated: infrastructure/environments/dev/stacks.auto.tfvars
Successfully generated tfvars files for 1 environment(s)
```

**Warning (Script Missing)**:
```
Warning: generate-stack-toggles.py not found. Skipping stack toggle generation...
```

**Warning (Generation Failed)**:
```
Warning: Failed to generate stack toggles. Proceeding with existing tfvars...
```

### Check Generated Files

After a deployment, verify the generated files in your repository:

```bash
# Check if files exist
ls -la infrastructure/environments/*/stacks.auto.tfvars

# View content for dev environment
cat infrastructure/environments/dev/stacks.auto.tfvars
```

Expected output:
```terraform
# Auto-generated from toggle-registry.yaml
# DO NOT EDIT THIS FILE MANUALLY
# Environment: dev

opensearch_stack_enabled = true
read_only_viewer_stack_enabled = true
ui_stack_enabled = true
```

### Verify Terraform Usage

In the Terraform plan/apply logs, check that the toggles are being read:

```
Terraform will perform the following actions:

  # Conditional resources based on stack toggles
  # When opensearch_stack_enabled = false, no OpenSearch resources shown
```

## Affected Workflows

The following GitHub Actions workflows use stack toggle generation:

1. **`deploy-infrastructure.yaml`** (reusable workflow)
   - Core infrastructure deployment
   - Called by other workflows

2. **`deploy-application-infrastructure.yaml`**
   - Application infrastructure deployment
   - Calls deploy-infrastructure.yaml

3. **`pipeline-deploy-application.yaml`**
   - Full application deployment pipeline
   - Uses deploy-application-infrastructure.yaml

4. **`pipeline-deploy-account-infrastructure.yaml`**
   - Account-level infrastructure
   - Calls deploy-infrastructure.yaml

## Manual Override

If you need to manually generate toggles (for testing):

```bash
# Generate for specific environment
python3 scripts/generate-stack-toggles.py --environment dev

# Generate for all environments
python3 scripts/generate-stack-toggles.py

# Dry run (preview without writing)
python3 scripts/generate-stack-toggles.py --dry-run
```

## Troubleshooting

### Issue: Toggles not being applied

**Symptoms**:
- Stack deploys even when toggle is `false` in registry
- Resources created when they shouldn't be

**Solutions**:
1. Check if `stacks.auto.tfvars` was generated in CI logs
2. Verify toggle registry syntax is correct
3. Check environment name matches exactly (case-sensitive)
4. Ensure PyYAML is installed in workflow

**Debug Commands**:
```bash
# In GitHub Actions, add debug step:
- name: Debug Stack Toggles
  run: |
    echo "Environment: ${{ inputs.environment }}"
    cat infrastructure/environments/${{ inputs.environment }}/stacks.auto.tfvars
    cat infrastructure/toggles/toggle-registry.yaml | grep -A 10 "stack_toggles"
```

### Issue: Generation script fails

**Symptoms**:
- Warning in CI logs about generation failure
- Deployment continues but uses old tfvars

**Solutions**:
1. Check toggle-registry.yaml for YAML syntax errors
2. Verify all required fields are present in toggle definitions
3. Check Python/PyYAML installation in workflow
4. Review script logs for specific error messages

**Test Locally**:
```bash
# Validate YAML syntax
python3 -c "import yaml; yaml.safe_load(open('infrastructure/toggles/toggle-registry.yaml'))"

# Test generation
python3 scripts/generate-stack-toggles.py --dry-run --environment dev
```

### Issue: Wrong environment toggles applied

**Symptoms**:
- Production toggles applied to dev
- Workspace-specific toggles not working

**Solutions**:
1. Verify `$ENVIRONMENT` variable is set correctly in workflow
2. Check environment name in toggle-registry.yaml matches exactly
3. Confirm workspace logic in script handles workspace vs environment correctly

## Environment Variables

The following environment variables are used:

- `$ENVIRONMENT` - Target environment (dev, test, int, ref, prod)
- `$WORKSPACE` - Terraform workspace (default or custom)
- `$ROOT_DIR` - Repository root directory

## Best Practices

1. **Always use toggle registry** - Never manually create `stacks.auto.tfvars`
2. **Commit toggle changes** - Changes to toggle-registry.yaml require PR and review
3. **Test in lower environments** - Always test toggle changes in dev/test first
4. **Monitor CI logs** - Check generation logs for warnings or errors
5. **Version control** - Keep toggle-registry.yaml in version control
6. **Document changes** - Use clear commit messages when changing toggles

## Integration Testing

### Test Toggle Change

1. Update toggle-registry.yaml (e.g., disable OpenSearch in test)
2. Commit and push changes
3. Trigger deployment to test environment
4. Verify in CI logs:
   - Toggle generation runs successfully
   - `stacks.auto.tfvars` shows `opensearch_stack_enabled = false`
   - Terraform plan shows 0 OpenSearch resources

### Test New Stack Toggle

1. Add new stack toggle to registry
2. Implement toggle in stack (variable, count, locals)
3. Commit changes
4. Deploy to dev environment
5. Verify:
   - New toggle appears in generated tfvars
   - Stack respects toggle setting
   - Resources created/skipped as expected

## Rollback Procedures

### Emergency Rollback

If toggle changes cause issues:

1. **Immediate**: Revert toggle-registry.yaml in Git
2. **Quick**: Manually create tfvars with safe values in environments
3. **Automated**: Re-run deployment with reverted registry

### Manual Override (Emergency Only)

```bash
# SSH to runner or run locally
cd infrastructure/environments/prod
echo "opensearch_stack_enabled = true" > stacks.auto.tfvars
# Commit and deploy
```

⚠️ **WARNING**: Manual tfvars changes will be overwritten on next deployment. Update toggle-registry.yaml permanently.

## Support

For issues with CI/CD integration:
- Check [Stack Toggles Developer Guide](../../docs/developer-guides/Stack_Toggles.md)
- Review [Toggle Registry README](../toggles/README.md)
- Contact Infrastructure Team
- Create Jira ticket with label `ci-cd-integration`

## Changelog

- **2026-01-17**: Initial CI/CD integration implemented
  - Added toggle generation to action-infra-stack.sh
  - Added Python setup to deploy-infrastructure.yaml
  - Automatic generation for all infrastructure deployments
