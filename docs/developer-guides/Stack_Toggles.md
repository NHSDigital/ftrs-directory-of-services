# Working with Stack Toggles

## Overview

Stack toggles provide the ability to enable or disable entire Terraform infrastructure stacks per environment. When a stack is disabled, **zero resources** are created, reducing costs and deployment complexity.

## Key Concepts

### What is a Stack Toggle?

A stack toggle is a Terraform boolean variable that controls whether all resources in an infrastructure stack are created. It uses Terraform's `count` meta-argument to conditionally create resources.

### Benefits

- **Cost Optimization**: Disable unused stacks in development/testing environments
- **Faster Deployments**: Skip provisioning of unnecessary infrastructure
- **Environment Flexibility**: Different stacks enabled per environment
- **Risk Reduction**: Fewer resources mean smaller blast radius

## Using Stack Toggles

### 1. Defining Stack Toggles

Stack toggles are defined in `infrastructure/toggles/toggle-registry.yaml`:

```yaml
stack_toggles:
  - id: stack_opensearch_enabled
    name: "OpenSearch Stack Enabled"
    description: "Enable/disable OpenSearch stack deployment"
    terraform_variable: opensearch_stack_enabled
    stack_path: infrastructure/stacks/opensearch
    owner: "Infrastructure Team"
    environments:
      workspace: true  # Local development
      dev: true
      test: true
      int: false
      ref: false
      sandpit: false
      prod: false
```

### 2. Generating Tfvars Files

Stack toggle values are **not** manually edited in tfvars files. Instead, they are generated from the toggle registry:

```bash
# From project root
cd /path/to/ftrs-directory-of-services

# Generate for all environments
python3 scripts/generate-stack-toggles.py

# Generate for specific environment
python3 scripts/generate-stack-toggles.py --environment dev

# Preview what would be generated (dry-run)
python3 scripts/generate-stack-toggles.py --dry-run
```

This creates `stacks.auto.tfvars` in each environment directory:

```terraform
# infrastructure/environments/dev/stacks.auto.tfvars
# Auto-generated from toggle-registry.yaml
# DO NOT EDIT THIS FILE MANUALLY
# Environment: dev

opensearch_stack_enabled = true
read_only_viewer_stack_enabled = true
ui_stack_enabled = true
```

### 3. CI/CD Integration

The CI pipeline automatically generates tfvars files before Terraform deployment:

```yaml
# In GitHub Actions workflow
- name: Generate Stack Toggles
  run: |
    python3 scripts/generate-stack-toggles.py --environment ${{ env.ENVIRONMENT }}
    
- name: Terraform Plan
  run: terraform plan
```

## Implementing a New Stack Toggle

### Step 1: Add Variable to Stack

Create or update `infrastructure/stacks/{stack_name}/variables.tf`:

```terraform
variable "my_stack_stack_enabled" {
  description = "Enable or disable the my_stack stack"
  type        = bool
  default     = true
}
```

### Step 2: Create Local Variable

Create `infrastructure/stacks/{stack_name}/locals.tf`:

```terraform
locals {
  stack_enabled = var.my_stack_stack_enabled ? 1 : 0
}
```

### Step 3: Add Count to All Resources

Update all root-level resources and modules:

```terraform
# Before
module "s3" {
  source = "../../modules/s3"
  bucket_name = "my-bucket"
}

# After
module "s3" {
  count = local.stack_enabled
  source = "../../modules/s3"
  bucket_name = "my-bucket"
}
```

### Step 4: Update Resource References

Any resource that references another must use the count index `[0]`:

```terraform
# Before
resource "aws_s3_bucket_policy" "policy" {
  bucket = module.s3.s3_bucket_id
}

# After
resource "aws_s3_bucket_policy" "policy" {
  count = local.stack_enabled
  bucket = module.s3[0].s3_bucket_id
}
```

### Step 5: Update Outputs

Make outputs conditional:

```terraform
# Before
output "bucket_name" {
  value = module.s3.s3_bucket_name
  description = "The S3 bucket name"
}

# After
output "bucket_name" {
  value = local.stack_enabled == 1 ? module.s3[0].s3_bucket_name : ""
  description = "The S3 bucket name"
}
```

### Step 6: Add to Toggle Registry

Add the toggle definition to `infrastructure/toggles/toggle-registry.yaml`:

```yaml
stack_toggles:
  - id: stack_my_stack_enabled
    name: "My Stack Enabled"
    description: "Enable/disable my stack deployment"
    terraform_variable: my_stack_stack_enabled
    stack_path: infrastructure/stacks/my_stack
    owner: "My Team"
    environments:
      workspace: true
      dev: true
      test: true
      int: false
      ref: false
      sandpit: false
      prod: false
```

### Step 7: Test the Toggle

```bash
# Generate tfvars
python3 scripts/generate-stack-toggles.py --environment dev

# Initialize Terraform
cd infrastructure/environments/dev
terraform init

# Plan with stack enabled
terraform plan

# Test with stack disabled
echo 'my_stack_stack_enabled = false' > test.tfvars
terraform plan -var-file=test.tfvars

# Verify zero resources are planned when disabled
```

## Common Patterns

### Resources with for_each

For resources using `for_each`, make the collection conditional:

```terraform
# Before
resource "aws_osis_pipeline" "pipeline" {
  for_each = toset(var.table_names)
  # ... configuration
}

# After
resource "aws_osis_pipeline" "pipeline" {
  for_each = local.stack_enabled == 1 ? toset(var.table_names) : []
  # ... configuration
}
```

### Resources with Existing Count

For resources that already use `count`, combine conditions:

```terraform
# Before
resource "aws_opensearchserverless_security_policy" "policy" {
  count = local.is_primary_environment ? 1 : 0
  # ... configuration
}

# After
resource "aws_opensearchserverless_security_policy" "policy" {
  count = local.stack_enabled == 1 && local.is_primary_environment ? 1 : 0
  # ... configuration
}
```

### Data Sources

Data sources that are only needed when the stack is enabled should also use count:

```terraform
data "aws_opensearchserverless_collection" "collection" {
  count = local.stack_enabled
  name  = "${local.project_prefix}-osc"
}

# Reference it elsewhere
collection_endpoint = local.stack_enabled == 1 ? data.aws_opensearchserverless_collection.collection[0].endpoint : ""
```

## Troubleshooting

### Error: "count cannot be computed"

**Problem**: Terraform cannot determine count at plan time.

**Solution**: Ensure `stack_enabled` is a simple conditional, not dependent on computed values:

```terraform
# Good
locals {
  stack_enabled = var.opensearch_stack_enabled ? 1 : 0
}

# Bad - depends on data source
locals {
  stack_enabled = length(data.aws_subnets.subnets.ids) > 0 ? 1 : 0
}
```

### Error: "Resource does not exist" when referencing

**Problem**: Forgot to add `[0]` when referencing a counted resource.

**Solution**: Always use index when referencing:

```terraform
# Wrong
module.s3.bucket_id

# Correct
module.s3[0].bucket_id
```

### Outputs Return Empty Values

**Problem**: Outputs not handling disabled state.

**Solution**: Use conditional expression:

```terraform
output "value" {
  value = local.stack_enabled == 1 ? resource.example[0].id : ""
}
```

### Terraform Plan Shows Changes Every Time

**Problem**: The auto-generated tfvars file is not being used.

**Solution**: Ensure `stacks.auto.tfvars` is generated and in the correct directory. Terraform automatically loads `*.auto.tfvars` files.

## Best Practices

1. **Always use `local.stack_enabled`** - Don't reference `var.{stack}_stack_enabled` directly in resources
2. **Generate tfvars from registry** - Never manually edit `stacks.auto.tfvars` files
3. **Test both states** - Always test with toggle enabled and disabled
4. **Update CI pipelines** - Ensure toggle generation runs before Terraform commands
5. **Document dependencies** - If your stack depends on another stack, document it
6. **Conservative defaults** - Set `default = true` in the variable definition to avoid accidents
7. **Consistent naming** - Follow the pattern: `{stack_name}_stack_enabled`

## Validation Checklist

Before merging a PR that adds or modifies stack toggles:

- [ ] Toggle added to `toggle-registry.yaml` with all environments configured
- [ ] Variable added to `variables.tf` with `default = true`
- [ ] `locals.tf` created/updated with `stack_enabled` local
- [ ] All root-level resources have `count = local.stack_enabled`
- [ ] All resource references use `[0]` index
- [ ] All outputs handle disabled state
- [ ] Terraform plan succeeds with toggle enabled
- [ ] Terraform plan shows zero resources with toggle disabled
- [ ] Generate script tested: `python3 scripts/generate-stack-toggles.py --dry-run`
- [ ] Documentation updated (if applicable)

## Examples

See the following stacks for reference implementations:

- `infrastructure/stacks/opensearch/` - Complex stack with for_each and conditional resources
- `infrastructure/stacks/read_only_viewer/` - Stack with CloudFront, Lambda, and monitoring
- `infrastructure/stacks/ui/` - Stack with DynamoDB, Lambda, and multiple modules

## Related Documentation

- [Toggle Registry README](../toggles/README.md)
- [Terraform Documentation](../README.md)
- [CI/CD Pipeline Documentation](../../docs/developer-guides/)

## Support

For questions or issues with stack toggles:

1. Check this guide and the Toggle Registry README
2. Review example implementations in existing stacks
3. Contact the Infrastructure Team
4. Create a ticket in Jira with label `stack-toggles`
